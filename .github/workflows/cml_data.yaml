name: DVC Workflow

on:
  pull_request:
    branches:
    - main
    - development
    - DVC-Workflow
  push:
    branches:
    - main
    - development
    - DVC-Workflow
    paths:
    - '**/*.dvc'
    - '.dvc/**'
  workflow_dispatch: {}

jobs:
  dvc:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout Code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Setup UV
    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    # 3. Install DVC
    - name: Install DVC
      run: |
        uv tool install dvc
        uv tool install "dvc[gs]"

    # 4. Authenticate with Google Cloud
    # This uses the Service Account Key you stored in GitHub Secrets
    - name: Auth with GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.gcp_key }}

    # 4b. Cache the DVC directory
    - name: Cache DVC storage
      uses: actions/cache@v4
      with:
        path: .dvc/cache
        # Hash ALL .dvc files so cache invalidates when ANY data updates
        key: dvc-cache-${{ hashFiles('**/*.dvc') }}
        restore-keys: |
          dvc-cache-

    # 5. Pull the Data
    # -j 16 speeds up the "cold" download if cache is missing
    - name: Pull data from DVC
      run: |
        dvc pull --no-run-cache -j 16
        
    # 6. Run Data Quality Checks
    - name: Run Data Quality Checks
      env:
        # Define these variables so the script knows how to label files!
        PYTHONPATH: "src"
        TASK: "binary"  # or "multiclass"
        FILE_PATTERN: "card_class_{}_embeddings.h5" 
        CLASSES: "class_a,class_b,class_c,class_d" # Only needed if task is multiclass
      run: |
        # Run the script as a module
        python -m arginator_protein_classifier.data_validation

    # 7. Publish Report to PR
    - name: Setup CML
      if: always()
      uses: iterative/setup-cml@v2

    - name: Comment Report
      if: always()
      env:
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cml comment create data_report.md